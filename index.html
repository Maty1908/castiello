<script>
const cart = [];
const cartOffcanvas = document.getElementById('cart-offcanvas');
const totalOffcanvas = document.getElementById('total-offcanvas');
const metodoPagoInput = document.getElementById('pagoMetodo');
const cartCount = document.getElementById('cart-count');
let selectedPaymentMethod = 'Transferencia';

// Funciones globales
function changeQuantity(index, delta){
  cart[index].quantity += delta;
  if(cart[index].quantity < 1) cart[index].quantity = 1;
  updateCart();
}

function removeItem(index){
  cart.splice(index,1);
  updateCart();
}

// Agregar productos al carrito (sin validar sesión)
document.querySelectorAll('.add-to-cart').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const name = btn.dataset.name;
    const price = Number(btn.dataset.price);
    const foundIndex = cart.findIndex(i => i.name === name);
    if(foundIndex > -1) cart[foundIndex].quantity++;
    else cart.push({name, price, quantity:1});
    updateCart();
  });
});

// Actualizar carrito
function updateCart(){
  cartOffcanvas.innerHTML = '';
  let total = 0;
  cart.forEach((item,index)=>{
    const liOff = document.createElement('li');
    liOff.className = "list-group-item d-flex justify-content-between align-items-center";
    liOff.innerHTML = `<span>${item.name}</span>
                       <div>
                         <button onclick="changeQuantity(${index},-1)">−</button>
                         <span>${item.quantity}</span>
                         <button onclick="changeQuantity(${index},1)">+</button>
                       </div>
                       <span>$${item.price*item.quantity}</span>`;
    cartOffcanvas.appendChild(liOff);
    total += item.price*item.quantity;
  });
  totalOffcanvas.textContent = `Total: $${total}`;
  cartCount.textContent = cart.reduce((acc,i)=>acc+i.quantity,0);
}

updateCart();

// Finalizar compra
document.getElementById('btnFinalizar').addEventListener('click', function(){
  if(cart.length === 0){
    alert('El carrito está vacío. Agregá productos antes de confirmar.');
    return;
  }

  // Validar sesión solo al FINALIZAR
  const userDataJSON = localStorage.getItem('userData');
  if(!userDataJSON){
    alert('Tenés que iniciar sesión antes de finalizar la compra.');
    window.location.href = 'inicio.sesion.html';
    return;
  }

  const userData = JSON.parse(userDataJSON);
  document.getElementById('hiddenName').value = userData.name;
  document.getElementById('hiddenEmail').value = userData.email;
  document.getElementById('hiddenAddress').value = userData.cellphone || '';
  metodoPagoInput.value = selectedPaymentMethod;

  const pedido = cart.map(i => `${i.name} - ${i.quantity} x $${i.price}`).join(', ');
  const total = cart.reduce((acc,i) => acc + i.price*i.quantity, 0);
  localStorage.setItem('montoTotal', total);
  document.getElementById('pedidoResumen').value = `Pedido: ${pedido}. Total: $${total}`;

  document.getElementById('order-form').submit();
});
</script>
</body>
</html>
